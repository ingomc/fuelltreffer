---
import Layout from '../../../../layouts/Layout.astro';

const { eventId, matchId } = Astro.params;

// Get team parameter if present (for back navigation)
const teamParam = Astro.url.searchParams.get('team');
const backUrl = teamParam ? `/?team=${teamParam}` : '/';
---

<Layout title={`Match Details - ${matchId}`}>
  <main class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <!-- Header with back button -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center gap-4">
          <a 
            href={backUrl}
            class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors text-gray-900 dark:text-gray-100"
          >
            <span>‚Üê</span>
            <span>Zur√ºck</span>
          </a>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
            üéØ Match Report
          </h1>
        </div>
      </div>
    </div>

    <!-- Match Report Component -->
    <div class="container mx-auto px-2 py-4 md:px-4 md:py-8">
      <div id="match-report-container" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 md:p-6">
        <!-- Loading state -->
        <div id="loading" class="flex items-center justify-center py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
        
        <!-- Error state -->
        <div id="error" class="hidden text-center py-12">
          <span class="text-4xl">‚ùå</span>
          <p class="text-red-600 dark:text-red-400 mt-2">Fehler beim Laden des Match Reports</p>
          <p id="error-message" class="text-gray-500 text-sm mt-1"></p>
        </div>
        
        <!-- Content -->
        <div id="content" class="hidden space-y-6"></div>
      </div>
    </div>
  </main>
</Layout>

<script type="module">
  import { trackEvent, trackDartEvents } from '/src/utils/umami.js';
  
  // Get variables from Astro
  const eventId = '{eventId}';
  const matchId = '{matchId}';
  const teamParam = '{teamParam}';
  
  // Track initial page load
  trackEvent('match_report_loaded', {
    event_id: String(eventId),
    match_id: String(matchId),
    has_team_param: !!teamParam && teamParam !== '',
    team_param: teamParam && teamParam !== '' ? teamParam : null
  });

  // Expose to window for use in other parts of the script
  window.trackEvent = trackEvent;
  window.trackDartEvents = trackDartEvents;
</script>

<script define:vars={{ eventId, matchId, teamParam }}>
  // Fetch match report data
  async function fetchMatchReport() {
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const errorMessageEl = document.getElementById('error-message');
    const contentEl = document.getElementById('content');

    try {
      // Fetch report first
      const reportResponse = await fetch(`/api/match/${eventId}/${matchId}/report`);
      
      if (!reportResponse.ok) {
        throw new Error(`HTTP error! status: ${reportResponse.status}`);
      }
      
      const reportData = await reportResponse.json();
      
      const firstGame = reportData[0];
      const phaseId = firstGame.round?.phase?.id || firstGame.phase?.id;
      const roundIndex = firstGame.round?.roundIndex !== undefined ? firstGame.round.roundIndex : firstGame.roundNr;
      
      // Simpler approach: Just load statistics for each game in THIS match report
      // We already have all games in reportData!
      const gameStatsMap = new Map();
      
      for (const game of reportData) {
        if (game.id) {
          try {
            const statsResponse = await fetch(`/api/match/${eventId}/${game.id}/statistics`);
            
            if (statsResponse.ok) {
              const gameStats = await statsResponse.json();
              if (gameStats.length > 0) {
                // Store stats with the game ID as key
                const matchStats = gameStats.filter(s => s.type === 'MATCH');
                if (matchStats.length > 0) {
                  gameStatsMap.set(game.id, matchStats);
                }
              }
            }
          } catch (e) {
            console.error(`  ‚ùå Failed to load stats for game ${game.id}:`, e);
          }
        }
      }
      
      // Load team roster if teamParam is provided
      let teamRoster = null;
      if (teamParam) {
        try {
          const rosterResponse = await fetch(`/api/participant/${teamParam}`);
          if (rosterResponse.ok) {
            const rosterData = await rosterResponse.json();
            const rosterMembers = rosterData?.participant?.teamSeason?.teamMembers || [];
            const matchSummary = (rosterData?.matches || []).find(
              (match) => String(match?.id) === String(matchId)
            ) || null;

            teamRoster = {
              members: rosterMembers,
              match: matchSummary
            };
          }
        } catch (e) {
          console.error('Failed to load team roster:', e);
        }
      }
      
      // Hide loading
      loadingEl.classList.add('hidden');
      
      // Show content
      contentEl.classList.remove('hidden');
      
      // Track successful report load
      if (window.trackEvent) {
        window.trackEvent('match_report_success', {
          event_id: String(eventId),
          match_id: String(matchId),
          games_count: reportData.length,
          has_team_roster: !!teamRoster,
          stats_games_count: gameStatsMap.size
        });
      }
      
      // Render the match report
      renderMatchReport(reportData, gameStatsMap, teamRoster, contentEl);
      
    } catch (error) {
      console.error('Error fetching match report:', error);
      
      // Track error
      if (window.trackEvent) {
        window.trackEvent('match_report_error', {
          event_id: String(eventId),
          match_id: String(matchId),
          error_message: error.message,
          error_type: 'fetch_error'
        });
      }
      
      // Hide loading
      loadingEl.classList.add('hidden');
      
      // Show error
      errorEl.classList.remove('hidden');
      errorMessageEl.textContent = error.message;
    }
  }

  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString('de-DE', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function formatDuration(seconds) {
    if (!seconds) return 'N/A';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')} min`;
  }

  /**
   * Calculate the 3-dart average for darts
   * 
   * @param {number} scoreTotal - Total points scored
   * @param {number} dartsTotal - Total number of darts thrown
   * @returns {string|number} - The 3-dart average as a string with 2 decimal places, or 0 if no darts thrown
   * 
   * Formula: (scoreTotal / dartsTotal) * 3
   * 
   * Example:
   * - If a player scores 180 points with 9 darts:
   *   AVG = (180 / 9) * 3 = 60.00
   * 
   * The multiplication by 3 converts the per-dart average to a 3-dart average,
   * which is the standard measurement in darts.
   */
  function calculateAverage(scoreTotal, dartsTotal) {
    if (!dartsTotal || dartsTotal === 0) return 0;
    return (scoreTotal / dartsTotal * 3).toFixed(2);
  }

  function renderMatchReport(data, gameStatsMap, teamRoster, container) {
    if (!data || data.length === 0) {
      container.innerHTML = '<p class="text-center text-gray-500">Keine Daten verf√ºgbar</p>';
      return;
    }

    // Get first match for general info
    const firstMatch = data[0];
    
    // Try to find team names by looking at all participants
    // Group by home/away and collect unique team names
    const homeTeams = new Set();
    const awayTeams = new Set();
    const summaryHomeTeamName = teamRoster?.match?.participantHome?.displayName || null;
    const summaryAwayTeamName = teamRoster?.match?.participantGuest?.displayName || null;
    
    data.forEach(match => {
      const homeName = match.participantHome?.teamSeason?.team?.name || match.participantHome?.displayName;
      const awayName = match.participantGuest?.teamSeason?.team?.name || match.participantGuest?.displayName;
      if (homeName) homeTeams.add(homeName);
      if (awayName) awayTeams.add(awayName);
    });
    
    const homeTeamName = summaryHomeTeamName ||
                         (homeTeams.size === 1 ? [...homeTeams][0] : 
                         firstMatch.participantHome?.teamSeason?.team?.name || firstMatch.participantHome?.displayName || 
                         'Heimteam');
    const awayTeamName = summaryAwayTeamName ||
                         (awayTeams.size === 1 ? [...awayTeams][0] : 
                         firstMatch.participantGuest?.teamSeason?.team?.name || firstMatch.participantGuest?.displayName || 
                         'Gastteam');
    
    let html = '';

    // Compact Header with Score - Count won games (matches), not legs
    const totalGamesHome = data.filter(m => m.legsHome > m.legsAway).length;
    const totalGamesAway = data.filter(m => m.legsAway > m.legsHome).length;
    const totalLegsHome = data.reduce((sum, m) => sum + (m.legsHome || 0), 0);
    const totalLegsAway = data.reduce((sum, m) => sum + (m.legsAway || 0), 0);
    
    html += `
      <div class="bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-lg px-3 py-3 text-white">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm opacity-90">${firstMatch.event?.name || 'Liga'} ‚Ä¢ ${firstMatch.round?.name || 'Runde'}</div>
          <div class="text-sm opacity-90">Match #${firstMatch.gameNr || ''}</div>
        </div>
        
        <div class="grid grid-cols-3 gap-4 items-center">
          <!-- Home Team -->
          <div class="text-center">
            <div class="text-xs opacity-75 mb-1">üè† Heim</div>
            <div class="text-lg font-bold mb-1">${homeTeamName}</div>
            <div class="text-3xl font-bold">${totalGamesHome}</div>
            <div class="text-xs opacity-75 mt-1">${totalLegsHome} Legs</div>
          </div>
          
          <!-- VS & Info -->
          <div class="text-center">
            <div class="text-2xl font-bold opacity-50 mb-1">VS</div>
            <div class="text-xs opacity-75">
              ${formatDate(firstMatch.beginDate || firstMatch.datePlanned).split(',')[0]}
            </div>
            ${firstMatch.duration ? `
              <div class="text-xs opacity-75">‚è±Ô∏è ${formatDuration(firstMatch.duration)}</div>
            ` : ''}
          </div>
          
          <!-- Away Team -->
          <div class="text-center">
            <div class="text-xs opacity-75 mb-1">üöó Gast</div>
            <div class="text-lg font-bold mb-1">${awayTeamName}</div>
            <div class="text-3xl font-bold">${totalGamesAway}</div>
            <div class="text-xs opacity-75 mt-1">${totalLegsAway} Legs</div>
          </div>
        </div>
      </div>
    `;

    // Compact Match Details
    html += `
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg px-2 py-2">
        <div class="flex items-center justify-between text-sm">
          <div class="flex gap-4">
            <div><span class="text-gray-600 dark:text-gray-400">Modus:</span> <span class="font-bold text-gray-900 dark:text-gray-100">${firstMatch.matchmode?.matchmodePoints || 'N/A'}</span></div>
            <div><span class="text-gray-600 dark:text-gray-400">In/Out:</span> <span class="font-medium text-gray-900 dark:text-gray-100">${firstMatch.matchmode?.matchmodeInCd} / ${firstMatch.matchmode?.matchmodeOutCd}</span></div>
            <div><span class="text-gray-600 dark:text-gray-400">Legs:</span> <span class="font-medium text-gray-900 dark:text-gray-100">Best of ${firstMatch.matchmode?.legsBestOf || 'N/A'}</span></div>
          </div>
          <div class="px-2 py-1 rounded text-xs font-medium ${
            firstMatch.statusCd === 'FINISH' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' :
            firstMatch.statusCd === 'ACTIVE' ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200' :
            'bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200'
          }">
            ${firstMatch.statusCd === 'FINISH' ? '‚úÖ Beendet' :
              firstMatch.statusCd === 'ACTIVE' ? 'üü¢ Aktiv' :
              firstMatch.statusCd || 'Offen'}
          </div>
        </div>
      </div>
    `;

    // Group games by block
    const blockGroups = {};
    data.forEach(game => {
      const blockKey = game.matchReportBlock ? 
        `${game.matchReportBlock.blockIndex}_${game.matchReportBlock.matchTypeCd}` : 
        'other';
      
      if (!blockGroups[blockKey]) {
        blockGroups[blockKey] = {
          block: game.matchReportBlock,
          games: []
        };
      }
      blockGroups[blockKey].games.push(game);
    });

    // Render blocks
    Object.entries(blockGroups).forEach(([key, group]) => {
      const block = group.block;
      const games = group.games;
      
      if (!block) return;
      
      const matchTypeLabel = block.matchTypeCd === 'EZ' ? 'Einzel' : 
                            block.matchTypeCd === 'DP' ? 'Doppel' : 
                            block.matchTypeCd;
      
      html += `
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
          <!-- Block Header -->
          <div class="bg-gradient-to-r from-orange-500 to-orange-600 dark:from-orange-600 dark:to-orange-700 px-2 py-2 flex items-center justify-between text-white">
            <div class="font-bold">
              ${block.blockIndex}. Block: ${block.numberOfMatches} ${matchTypeLabel}
            </div>
            <div class="text-sm opacity-90">
              Best of ${block.matchmode?.legsBestOf || 3} Legs, ${block.matchmode?.matchmodePoints || 501}
            </div>
          </div>
          
          <!-- Games in Block -->
          <div class="bg-gray-900 dark:bg-gray-950">
      `;
      
      games.forEach((game, index) => {
        const winner = game.legsHome > game.legsAway ? 'home' : game.legsAway > game.legsHome ? 'away' : 'draw';
        const boardIcon = game.matchReportBlock?.blockIndex ? 
          `<div class="w-8 h-8 bg-blue-500 dark:bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm">${game.gameNrRound || index + 1}</div>` :
          '';
        
        // Get player names
        const homePlayer = game.participantHome?.displayName || 'N/A';
        const awayPlayer = game.participantGuest?.displayName || 'N/A';
        
        // Get player IDs
        const homePlayerId = game.participantHome?.id;
        const awayPlayerId = game.participantGuest?.id;
        
        // Find statistics for this specific game from the map
        let homeAvg = '-';
        let awayAvg = '-';
        
        const gameStats = gameStatsMap.get(game.id);
        if (gameStats && gameStats.length > 0) {
          // Find stats for home player
          const homeStats = gameStats.find(s => 
            s.participant?.id === homePlayerId || s.displayName === homePlayer
          );
          
          // Find stats for away player
          const awayStats = gameStats.find(s => 
            s.participant?.id === awayPlayerId || s.displayName === awayPlayer
          );
          
          if (homeStats && homeStats.dartsTotal > 0) {
            homeAvg = calculateAverage(homeStats.scoreTotal, homeStats.dartsTotal);
          }
          
          if (awayStats && awayStats.dartsTotal > 0) {
            awayAvg = calculateAverage(awayStats.scoreTotal, awayStats.dartsTotal);
          }
        }
        
        // Determine text colors based on winner
        const homeColor = winner === 'home' ? 'text-green-400' : 'text-white';
        const awayColor = winner === 'away' ? 'text-green-400' : 'text-white';
        
        html += `
          <div class="px-2 py-2 border-b border-gray-800 dark:border-gray-900 hover:bg-gray-800 dark:hover:bg-gray-900 transition-colors">
            <div class="flex items-center gap-2">
              <!-- Home Player with Average -->
              <div class="flex-1 text-right">
                <div class="${homeColor} text-sm font-medium">${homePlayer}</div>
                <div class="text-xs ${homeAvg !== '-' ? 'text-blue-400' : 'text-gray-500'}">${homeAvg !== '-' ? '√ò ' + homeAvg : ''}</div>
              </div>
              
              <!-- Score -->
              <div class="text-xl font-bold text-white px-2 whitespace-nowrap">
                ${game.legsHome || 0}-${game.legsAway || 0}
              </div>
              
              <!-- Away Player with Average -->
              <div class="flex-1 text-left">
                <div class="${awayColor} text-sm font-medium">${awayPlayer}</div>
                <div class="text-xs ${awayAvg !== '-' ? 'text-blue-400' : 'text-gray-500'}">${awayAvg !== '-' ? '√ò ' + awayAvg : ''}</div>
              </div>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    });

    // Player Statistics - Alle Spieler mit ihren Spielen am Spieltag
    if (gameStatsMap && gameStatsMap.size > 0) {
      // Flatten all stats from the map
      const allMatchStats = [];
      gameStatsMap.forEach((stats, gameId) => {
        // Add gameId to each stat for reference
        stats.forEach(stat => {
          allMatchStats.push({ ...stat, gameId: gameId });
        });
      });
      
      const matchStats = allMatchStats;
      
      // Bestimme welches Team die ausgew√§hlte Mannschaft ist (aus teamParam)
      const selectedTeamId = teamParam ? parseInt(teamParam) : null;
      
      // Finde heraus welches Team Heim/Gast ist
      const firstGame = data[0];
      const homeTeamId = firstGame.participantHome?.teamSeason?.team?.id;
      const awayTeamId = firstGame.participantGuest?.teamSeason?.team?.id;
      
      // Alle Spieler der ausgew√§hlten Mannschaft (aus Team Roster)
      let allTeamPlayers = [];
      let isHomeTeam = false;
      
      if (teamRoster && teamRoster.members) {
        allTeamPlayers = teamRoster.members.map(m => ({
          id: m.id,
          name: m.displayName || m.name || 'N/A'
        }));
        console.log('üë• Team roster loaded:', allTeamPlayers.length, 'players');
        
        // Pr√ºfe ob selected team = home oder away
        isHomeTeam = selectedTeamId === homeTeamId;
        console.log('Selected team is:', isHomeTeam ? 'HOME' : 'AWAY');
      }
      
      // Gruppiere Statistiken nach Spieler-ID oder Name
      const playerStatsMap = new Map();
      
      matchStats.forEach(stat => {
        // Verwende participant ID als Key, falls vorhanden
        const key = stat.participant?.id || stat.displayName;
        if (!playerStatsMap.has(key)) {
          playerStatsMap.set(key, []);
        }
        playerStatsMap.get(key).push(stat);
      });
      
      // Sammle ALLE Spieler von BEIDEN Teams
      const allHomeParticipants = new Map(); // name -> player info
      const allAwayParticipants = new Map(); // name -> player info
      
      data.forEach(game => {
        // Home team
        if (game.participantHome) {
          const name = game.participantHome.displayName || 'N/A';
          if (!allHomeParticipants.has(name)) {
            allHomeParticipants.set(name, {
              id: game.participantHome.id,
              name: name,
              games: []
            });
          }
          allHomeParticipants.get(name).games.push(game.id);
        }
        
        // Away team
        if (game.participantGuest) {
          const name = game.participantGuest.displayName || 'N/A';
          if (!allAwayParticipants.has(name)) {
            allAwayParticipants.set(name, {
              id: game.participantGuest.id,
              name: name,
              games: []
            });
          }
          allAwayParticipants.get(name).games.push(game.id);
        }
      });
      
      // Baue Statistiken f√ºr Heim-Team
      const homePlayerStats = new Map();
      allHomeParticipants.forEach((playerInfo, playerName) => {
        // Get all stats for this player (by ID or name)
        const allPlayerStats = playerStatsMap.get(playerInfo.id) || 
                               playerStatsMap.get(playerName) || 
                               [];
        
        // Filter stats to only include games this player actually participated in
        // This ensures the overall AVG is calculated only from the player's actual games
        const stats = allPlayerStats.filter(stat => playerInfo.games.includes(stat.gameId));
        
        homePlayerStats.set(playerName, {
          stats: stats,
          gamesPlayed: playerInfo.games.length,
          gameIds: playerInfo.games
        });
      });
      
      // Baue Statistiken f√ºr Gast-Team
      const awayPlayerStats = new Map();
      allAwayParticipants.forEach((playerInfo, playerName) => {
        // Get all stats for this player (by ID or name)
        const allPlayerStats = playerStatsMap.get(playerInfo.id) || 
                               playerStatsMap.get(playerName) || 
                               [];
        
        // Filter stats to only include games this player actually participated in
        // This ensures the overall AVG is calculated only from the player's actual games
        const stats = allPlayerStats.filter(stat => playerInfo.games.includes(stat.gameId));
        
        awayPlayerStats.set(playerName, {
          stats: stats,
          gamesPlayed: playerInfo.games.length,
          gameIds: playerInfo.games
        });
      });      html += '<div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden mt-6">';
      html += '<div class="bg-gradient-to-r from-purple-500 to-purple-600 dark:from-purple-600 dark:to-purple-700 p-3 text-white font-bold">';
      html += 'üìä Spieler Statistiken';
      html += '</div>';
      
      // Home Team Stats
      if (homePlayerStats.size > 0) {
        const colorScheme = 'blue';
        
        html += '<div class="p-3 bg-' + colorScheme + '-50 dark:bg-' + colorScheme + '-950 border-b border-gray-200 dark:border-gray-700">';
        html += '<div class="font-bold text-' + colorScheme + '-900 dark:text-' + colorScheme + '-100 mb-3">üè† ' + homeTeamName + '</div>';
        html += '<div class="overflow-x-auto">';
        html += '<table class="w-full text-sm border-collapse">';
        html += '<thead class="text-xs text-' + colorScheme + '-700 dark:text-' + colorScheme + '-300 bg-' + colorScheme + '-100 dark:bg-' + colorScheme + '-900">';
        html += '<tr>';
        html += '<th class="text-left p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">Spieler</th>';
        html += '<th class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">Spiele</th>';
        html += '<th class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">Legs Won</th>';
        html += '<th class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800 bg-' + colorScheme + '-200 dark:bg-' + colorScheme + '-800">√ò Gesamt</th>';
        
        // Find max number of games any player played
        let maxGames = 0;
        homePlayerStats.forEach(playerData => {
          if (playerData.stats.length > maxGames) maxGames = playerData.stats.length;
        });
        
        for (let i = 0; i < maxGames; i++) {
          html += '<th class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">Spiel ' + (i + 1) + '</th>';
        }
        
        html += '</tr>';
        html += '</thead>';
        html += '<tbody class="text-' + colorScheme + '-900 dark:text-' + colorScheme + '-100">';
      
        homePlayerStats.forEach((playerData, playerName) => {
          const playerGames = playerData.stats;
          
          // Calculate overall stats for this player
          // Overall AVG is calculated as the average of individual game averages
          // (not weighted by darts - simple arithmetic mean of game AVGs)
          const totalLegsWon = playerGames.reduce((sum, g) => sum + g.legCount, 0);
          
          let overallAvg = '-';
          if (playerGames.length > 0) {
            // Calculate average for each game, then average those averages
            const gameAverages = playerGames
              .map(g => {
                const avg = calculateAverage(g.scoreTotal, g.dartsTotal);
                return parseFloat(avg);
              })
              .filter(avg => !isNaN(avg)); // Filter out only invalid values, keep zero
            
            if (gameAverages.length > 0) {
              const sumOfAverages = gameAverages.reduce((sum, avg) => sum + avg, 0);
              overallAvg = (sumOfAverages / gameAverages.length).toFixed(2);
            }
          }
          
          html += '<tr class="border-b border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">';
          html += '<td class="p-2 font-medium border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">' + playerName + '</td>';
          html += '<td class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">' + playerData.gamesPlayed + '</td>';
          html += '<td class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">' + (totalLegsWon || '-') + '</td>';
          html += '<td class="text-center p-2 font-bold text-lg border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800 bg-' + colorScheme + '-100 dark:bg-' + colorScheme + '-900">' + overallAvg + '</td>';
          
          // Add individual game averages
          for (let i = 0; i < maxGames; i++) {
            if (i < playerGames.length) {
              const game = playerGames[i];
              const gameAvg = calculateAverage(game.scoreTotal, game.dartsTotal);
              const wonClass = game.won ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 font-bold' : '';
              html += '<td class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800 ' + wonClass + '">' + gameAvg + '</td>';
            } else {
              html += '<td class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800 text-gray-400">-</td>';
            }
          }
          
          html += '</tr>';
        });
        
        // Team Average Row
        let teamTotalDarts = 0;
        let teamTotalScore = 0;
        let teamTotalLegsWon = 0;
        let teamTotalGamesPlayed = 0;
        
        homePlayerStats.forEach((playerData) => {
          playerData.stats.forEach(game => {
            teamTotalDarts += game.dartsTotal;
            teamTotalScore += game.scoreTotal;
            teamTotalLegsWon += game.legCount;
          });
          teamTotalGamesPlayed += playerData.gamesPlayed;
        });
        
        const teamAvg = teamTotalDarts > 0 ? calculateAverage(teamTotalScore, teamTotalDarts) : '-';
        
        html += '<tr class="bg-' + colorScheme + '-200 dark:bg-' + colorScheme + '-800 font-bold">';
        html += '<td class="p-2 border border-' + colorScheme + '-300 dark:border-' + colorScheme + '-700">Team Durchschnitt</td>';
        html += '<td class="text-center p-2 border border-' + colorScheme + '-300 dark:border-' + colorScheme + '-700">' + homePlayerStats.size + '</td>';
        html += '<td class="text-center p-2 border border-' + colorScheme + '-300 dark:border-' + colorScheme + '-700">' + teamTotalLegsWon + '</td>';
        html += '<td class="text-center p-2 text-xl border border-' + colorScheme + '-300 dark:border-' + colorScheme + '-700 bg-' + colorScheme + '-300 dark:bg-' + colorScheme + '-700">' + teamAvg + '</td>';
        
        // Empty cells for individual games
        for (let i = 0; i < maxGames; i++) {
          html += '<td class="border border-' + colorScheme + '-300 dark:border-' + colorScheme + '-700"></td>';
        }
        
        html += '</tr>';
        
        html += '</tbody>';
        html += '</table>';
        html += '</div>';
        html += '</div>';
      }
      
      // Away Team Stats
      if (awayPlayerStats.size > 0) {
        const colorScheme = 'green';
        
        html += '<div class="p-3 bg-' + colorScheme + '-50 dark:bg-' + colorScheme + '-950">';
        html += '<div class="font-bold text-' + colorScheme + '-900 dark:text-' + colorScheme + '-100 mb-3">üöó ' + awayTeamName + '</div>';
        html += '<div class="overflow-x-auto">';
        html += '<table class="w-full text-sm border-collapse">';
        html += '<thead class="text-xs text-' + colorScheme + '-700 dark:text-' + colorScheme + '-300 bg-' + colorScheme + '-100 dark:bg-' + colorScheme + '-900">';
        html += '<tr>';
        html += '<th class="text-left p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">Spieler</th>';
        html += '<th class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">Spiele</th>';
        html += '<th class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">Legs Won</th>';
        html += '<th class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800 bg-' + colorScheme + '-200 dark:bg-' + colorScheme + '-800">√ò Gesamt</th>';
        
        // Find max number of games any player played
        let maxAwayGames = 0;
        awayPlayerStats.forEach(playerData => {
          if (playerData.stats.length > maxAwayGames) maxAwayGames = playerData.stats.length;
        });
        
        for (let i = 0; i < maxAwayGames; i++) {
          html += '<th class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">Spiel ' + (i + 1) + '</th>';
        }
        
        html += '</tr>';
        html += '</thead>';
        html += '<tbody class="text-' + colorScheme + '-900 dark:text-' + colorScheme + '-100">';
      
        awayPlayerStats.forEach((playerData, playerName) => {
          const playerGames = playerData.stats;
          
          // Calculate overall stats for this player
          // Overall AVG is calculated as the average of individual game averages
          // (not weighted by darts - simple arithmetic mean of game AVGs)
          const totalLegsWon = playerGames.reduce((sum, g) => sum + g.legCount, 0);
          
          let overallAvg = '-';
          if (playerGames.length > 0) {
            // Calculate average for each game, then average those averages
            const gameAverages = playerGames
              .map(g => {
                const avg = calculateAverage(g.scoreTotal, g.dartsTotal);
                return parseFloat(avg);
              })
              .filter(avg => !isNaN(avg)); // Filter out only invalid values, keep zero
            
            if (gameAverages.length > 0) {
              const sumOfAverages = gameAverages.reduce((sum, avg) => sum + avg, 0);
              overallAvg = (sumOfAverages / gameAverages.length).toFixed(2);
            }
          }
          
          html += '<tr class="border-b border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">';
          html += '<td class="p-2 font-medium border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">' + playerName + '</td>';
          html += '<td class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">' + playerData.gamesPlayed + '</td>';
          html += '<td class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800">' + (totalLegsWon || '-') + '</td>';
          html += '<td class="text-center p-2 font-bold text-lg border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800 bg-' + colorScheme + '-100 dark:bg-' + colorScheme + '-900">' + overallAvg + '</td>';
          
          // Add individual game averages
          for (let i = 0; i < maxAwayGames; i++) {
            if (i < playerGames.length) {
              const game = playerGames[i];
              const gameAvg = calculateAverage(game.scoreTotal, game.dartsTotal);
              const wonClass = game.won ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 font-bold' : '';
              html += '<td class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800 ' + wonClass + '">' + gameAvg + '</td>';
            } else {
              html += '<td class="text-center p-2 border border-' + colorScheme + '-200 dark:border-' + colorScheme + '-800 text-gray-400">-</td>';
            }
          }
          
          html += '</tr>';
        });
        
        // Team Average Row
        let teamTotalDarts = 0;
        let teamTotalScore = 0;
        let teamTotalLegsWon = 0;
        let teamTotalGamesPlayed = 0;
        
        awayPlayerStats.forEach((playerData) => {
          playerData.stats.forEach(game => {
            teamTotalDarts += game.dartsTotal;
            teamTotalScore += game.scoreTotal;
            teamTotalLegsWon += game.legCount;
          });
          teamTotalGamesPlayed += playerData.gamesPlayed;
        });
        
        const teamAvg = teamTotalDarts > 0 ? calculateAverage(teamTotalScore, teamTotalDarts) : '-';
        
        html += '<tr class="bg-' + colorScheme + '-200 dark:bg-' + colorScheme + '-800 font-bold">';
        html += '<td class="p-2 border border-' + colorScheme + '-300 dark:border-' + colorScheme + '-700">Team Durchschnitt</td>';
        html += '<td class="text-center p-2 border border-' + colorScheme + '-300 dark:border-' + colorScheme + '-700">' + awayPlayerStats.size + '</td>';
        html += '<td class="text-center p-2 border border-' + colorScheme + '-300 dark:border-' + colorScheme + '-700">' + teamTotalLegsWon + '</td>';
        html += '<td class="text-center p-2 text-xl border border-' + colorScheme + '-300 dark:border-' + colorScheme + '-700 bg-' + colorScheme + '-300 dark:bg-' + colorScheme + '-700">' + teamAvg + '</td>';
        
        // Empty cells for individual games
        for (let i = 0; i < maxAwayGames; i++) {
          html += '<td class="border border-' + colorScheme + '-300 dark:border-' + colorScheme + '-700"></td>';
        }
        
        html += '</tr>';
        
        html += '</tbody>';
        html += '</table>';
        html += '</div>';
        html += '</div>';
      }
      
      html += '</div>';
    } else {
      // Show message that no statistics are available
      html += '<div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden mt-6">';
      html += '<div class="bg-gradient-to-r from-purple-500 to-purple-600 dark:from-purple-600 dark:to-purple-700 p-3 text-white font-bold">';
      html += 'üìä Spieler Statistiken';
      html += '</div>';
      html += '<div class="p-6 text-center text-gray-500 dark:text-gray-400">';
      html += '<div class="text-4xl mb-3">üìä</div>';
      html += '<div class="text-lg font-medium mb-2">Keine Statistik-Daten verf√ºgbar</div>';
      html += '<div class="text-sm">F√ºr dieses Match wurden keine detaillierten Statistiken aufgezeichnet.</div>';
      html += '<div class="text-xs mt-2 text-gray-400">Nur Matches mit Dartsscorer haben Statistik-Daten.</div>';
      html += '</div>';
      html += '</div>';
    }

    // Compact Additional Info
    const infoItems = [];
    
    if (firstMatch.matchReportBlock) {
      infoItems.push(`Block ${firstMatch.matchReportBlock.blockIndex}: ${firstMatch.matchReportBlock.matchTypeCd} (${firstMatch.matchReportBlock.numberOfMatches} Spiele)`);
    }
    
    if (firstMatch.phase) {
      if (firstMatch.phase.numberOfGroups) infoItems.push(`${firstMatch.phase.numberOfGroups} Gruppen`);
      if (firstMatch.phase.lineupCd) infoItems.push(`Lineup: ${firstMatch.phase.lineupCd}`);
    }
    
    if (infoItems.length > 0) {
      html += `
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
          <div class="flex flex-wrap gap-2 text-xs text-gray-600 dark:text-gray-400">
            ${infoItems.map(item => `<span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">${item}</span>`).join('')}
          </div>
        </div>
      `;
    }

    // Debug section
    html += `
      <details class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
        <summary class="font-bold text-gray-900 dark:text-gray-100 cursor-pointer">üêõ Debug: Raw API Data</summary>
        <pre class="mt-2 text-xs overflow-auto bg-gray-200 dark:bg-gray-600 p-4 rounded text-gray-800 dark:text-gray-200 max-h-96">${JSON.stringify(data, null, 2)}</pre>
      </details>
    `;

    container.innerHTML = html;
  }

  // Fetch data on page load
  fetchMatchReport();
</script>

<style>
  /* Dark mode transitions */
  * {
    transition: background-color 0.2s, border-color 0.2s, color 0.2s;
  }
</style>
